{% extends "AppBundle::layout.html.twig" %}

{% block titre %}
  <a class="navbar-brand" href="{{ path('app_groupe', {'id_groupe': groupe.id}) }}">{{ groupe.titre }}</a>
  
  {% if groupe.avatar == null %}
    <span class="default-avatar m-0" style="background-color: {{ groupe.color  }};">{{ groupe.titre|first|upper }}</span>
  {% else %}
    <img src="{{ asset('bundles/app/avatar/'~ groupe.avatar) }}" class="img-fluid rounded mt-2 text-right" alt="avatar" style="max-width: 35px; max-height: 35px;">
  {% endif %}

{% endblock %}

{% block groupe %}
  <li class="nav-item" id="fiche-icon">
    <a class="nav-link" href="{{ path('app_groupe', {'id_groupe': groupe.id} ) }}">{{ groupe.nbFiche }}  <i class="fa fa-file-text-o" aria-hidden="true"></i></a>
  </li>
  <li class="nav-item" id="membre-list">
    <a class="nav-link" href="{{ path('app_membre', {'id_groupe': groupe.id}) }}">{{ groupe.nbMembre }}  <i class="fa fa-user-o" aria-hidden="true"></i></a>
  </li>
{% endblock %}

{% block body %}

<div class="row" id="menu-titre">
<h5 class="p-3 col-8" style="border-bottom: .0625rem solid #e8e8e8; border-right: 1rem solid transparent;">Fiche N°{{ fiche.id }}
    {% if favoris == true %}
    <i class="fa fa-star yellow pl-2" id="fiche-fav" data-fav="{{ favoris }}"></i>
    {% else %}
    <i class="fa fa-star-o grey pl-2" id="fiche-fav" data-fav="{{ favoris }}"></i>
    {% endif %}
  {% if (membre.hasRole('ROLE_ADMIN') or membre.user.id == fiche.auteur.id) %}
  <a href="{{ path('app_fiche_edit', {'id_fiche': fiche.id, 'id_groupe': groupe.id}) }}" class="pl-3" style="font-size: 0.8rem; ">edit</a>
  {% endif %}
</h5>
<h5 class="p-3 col-4" style="border-bottom: .0625rem solid #e8e8e8; border-left: 1rem solid transparent;">Sources
  {% if (membre.hasRole('ROLE_ADMIN') or membre.user.id == fiche.auteur.id) %}
  <a href="{{ path('app_ressource_add', {'ficheId':fiche.id, 'groupeId': groupe.id }) }}" class="pl-3" style="font-size: 0.8rem; ">ajouter</a>
  {% endif %}
</h5>
</div>
<div class="row" style="border-top: .25rem solid transparent;">

  <section class="col-8 placeholders pt-3" id="fiche">
    <div class="row">
      <div class="col-lg-12 col-md-12 col-sm-12 placeholder">
        <div class="card card-fiche">
          <div class="card-header">
            <div class="row">
              <div class=" col-12 text-left">
                <h5>{{ fiche.theme }}</h5>
              </div>
            </div>
            <div class="row">
              <div class=" col-8 text-left">
                <p class="m-0" style="font-size: 0.9rem; ">Auteur: {{ fiche.auteur.user.nom }}</p>
              </div>
              <div class=" col-4 text-right">
                <h6 class="m-0">
                  {{ fiche.note|rating(5) }}
                </h6>
              </div>
            </div>
            <div class="row">
              <div class=" col-12 text-left">
                <p class="m-0" style="font-size: 0.7rem; ">Difficulté : {{ fiche.difficulte }}  |  Durée : {{ fiche.duree}}</p>
              </div>
            </div>
          </div>
          <div class="card-block text-center">
            <h4 class="card-title pt-3">{{ fiche.titre }} 
              
            </h4>
            <p class="card-text p-3">{{ fiche.description }}</p>
          </div>
          <div class="card-footer text-muted">
            <a data-toggle="collapse" href="#comment" role="button" aria-expanded="false" aria-controls="comment">
              <div class="row">
                <h6 class="col-5 text-left m-0">{{ fiche.nbCommentaire }} commentaires</h6>
                <h6 class="col-7 m-0 text-right text-white">
                  {% for tag in tags %}
                  <span class="badge badge-color" style="background-color: {{ tag.color}};">{{tag.label}}</span>
                  {% endfor %}
                </h6>
              </div>
            </a>
          </div>
          
          <div  class="card-footer text-muted collapse" id="comment">
            {% for commentaire in commentaires %}
              <div class="row p-3 border-b">
                <span class="row p-2 w-100">
                  <img src="{{  asset('bundles/app/images/' ~commentaire.getMembre.getUser.avatar) }}" class="img-fluid rounded mr-3" alt="avatar" style="max-width: 35px; max-height: 35px;">
                  {{ commentaire.getMembre.getUser.prenom }} {{ commentaire.getMembre.getUser.nom}}
                </span>
                <span class="p-2 pl-3 row w-100">
                  {{ commentaire.contenu }}
                </span>
              </div>
            {% endfor %}
            <br>
            {{ form_start(form) }}
                {{ form_errors(form.contenu) }}
                {{ form_widget(form.contenu, { 'attr': {'class': 'form-control' }}) }}
                <input type="submit" class="btn btn-defaut-inv btn-lg pull-right mt-2" value="Envoyer" />
            {{ form_end(form) }}
          </div>
        </div>
      </div>
    </div>
  </section>
  <section class="col-4 text-center placeholders pt-3" id="source" style=" border-left: .0625rem solid #e8e8e8;">
    <div class="row"> 
      {% for ressource in ressources %}
      <div class="col-lg-6 col-md-6 col-sm-12 placeholder pb-2">
        <div class="card">
          <img class="card-img-top " src="https://www.openoffice.org/ui/VisualDesign/gifs/Icons/OOo30_final_mimetype/Galaxy_OOo3_writer-doc_256.png" alt="Card image cap">
          <div class="card-body p-0">
            <p class="text-muted m-0">{{ ressource.titre }}</p>
            <div class="row col-12 m-0 p-0">
              <a href="{{ path('app_ressource_view', { 'ficheId': fiche.id, 'groupeId': groupe.id, 'fileName': ressource.routeDoc }) }}" class="btn btn-sm btn-secondary {% if (membre.hasRole('ROLE_ADMIN') or membre.user == fiche.auteur) %} col-4 {% else %} col-6 {% endif %} rounded-0" target="_blank">
                <i class="fa fa-eye" aria-hidden="true"></i>
              </a>
              <a href="{{ path('app_ressource_dl', { 'ficheId': fiche.id, 'groupeId': groupe.id, 'fileName': ressource.routeDoc }) }}" class="btn btn-sm btn-secondary {% if (membre.hasRole('ROLE_ADMIN') or membre.user == fiche.auteur) %} col-4 {% else %} col-6 {% endif %} rounded-0">
                <i class="fa fa-cloud-download" aria-hidden="true"></i>
              </a>
              {% if (membre.hasRole('ROLE_ADMIN') or membre.user == fiche.auteur) %}
              <button id="route" type="button" data-route="{{ ressource.routeDoc }}" data-toggle="modal" data-target="#supprimer" class="btn-suppr btn btn-sm btn-secondary col-4 rounded-0"><i class="fa fa-trash" aria-hidden="true"></i></button>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    
  </section>
</div>

{% endblock %}

{% block modal %}

<div class="modal fade" id="supprimer" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Etes-vous sûr ?
        <button type="button" class="close text-right" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <h6>Cette action supprimera cette ressource définitivement.</h6>
      </div>
      <div class="modal-footer">
        <div class="row w-100">
        <div class="text-right col-9 pl-0">
          <form method="POST" action="{{ path('app_ressource_delete', { 'ficheId': fiche.id, 'groupeId': groupe.id}) }}">
            <input id="routeModal" type="hidden" name="route" value="">
            <input type="submit" name="submit" class="btn btn-danger btn-lg" value="Supprimer la ressource">
          </form>
        </div>
        <div class="text-right col-3">
          <button type="button" class="btn btn-secondary btn-lg" data-dismiss="modal">Fermer</button>
        </div>
      </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">
      $('.btn-suppr').each(function () {
        var $this = $(this);
        $this.on("click", function() {
          var route = $(this).attr('data-route');      
          $('#routeModal').val(route);
        });
      });
    </script>
    <script type="text/javascript">
      $( '#fiche-fav' ).click(function() {
        $.ajax({
            url: '{{ path("app_favoris_action") }}',
            type: 'POST',
            data: { fiche : '{{ fiche.id }}' },
            success: function(success) {
              if (success.add) {
                $('#fiche-fav').removeClass('fa-star-o grey').addClass('fa-star yellow');
              } 
              if (success.delete) {
                $('#fiche-fav').removeClass('fa-star yellow').addClass('fa-star-o grey');
              }
            }
        });
      });

    </script>
{% endblock %}